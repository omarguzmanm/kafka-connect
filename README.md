PRINT 'dbserver1.public.customers' FROM BEGINNING LIMIT 1;


CREATE STREAM CUSTOMERS_SOURCE (SCHEMA STRING, PAYLOAD STRUCT<BEFORE STRUCT<ID INTEGER, FIRST_NAME STRING, LAST_NAME STRING, EMAIL STRING, C
REATED_AT BIGINT>, AFTER STRUCT<ID INTEGER, FIRST_NAME STRING, LAST_NAME STRING, EMAIL STRING, CREATED_AT BIGINT>, SOURCE STRUCT<VERSION STR
ING, `connector` STRING, NAME STRING, TS_MS BIGINT, SNAPSHOT STRING, DB STRING, SEQUENCE STRING, `schema` STRING, `table` STRING, TXID BIGIN
T, LSN BIGINT, XMIN BIGINT>, OP STRING, TS_MS BIGINT, TRANSACTION STRUCT<ID STRING, TOTAL_ORDER BIGINT, DATA_COLLECTION_ORDER BIGINT>>) WITH
 (CLEANUP_POLICY='delete', KAFKA_TOPIC='dbserver1.public.customers', KEY_FORMAT='JSON', VALUE_FORMAT='JSON');

SELECT payload->after->id, payload->after->first_name, payload->op 
>FROM CUSTOMERS_SOURCE EMIT CHANGES LIMIT 1;


DROP STREAM IF EXISTS CUSTOMERS_NORMALIZED_FINAL;
>CREATE STREAM CUSTOMERS_NORMALIZED_FINAL WITH (
>    KAFKA_TOPIC='CUSTOMERS_NORMALIZED_FINAL',
>    VALUE_FORMAT='JSON',
>    PARTITIONS=1
>) AS
>SELECT
>    CAST(payload->after->id AS INTEGER) AS id,
>    UCASE(CAST(payload->after->first_name AS STRING)) AS first_name,
>    UCASE(CAST(payload->after->last_name AS STRING)) AS last_name,
>    LCASE(CAST(payload->after->email AS STRING)) AS email,
>    CAST(payload->after->created_at AS BIGINT) AS created_at
>FROM CUSTOMERS_SOURCE
>WHERE payload->op IN ('c', 'u', 'r') 
>  AND payload->after->id IS NOT NULL
>  AND payload->after->first_name IS NOT NULL
>  AND payload->after->last_name IS NOT NULL
>  AND payload->after->email IS NOT NULL
>EMIT CHANGES;

DROP STREAM IF EXISTS CUSTOMERS_NORMALIZED_FINAL;


CREATE STREAM CUSTOMERS_NORMALIZED_FINAL WITH (CLEANUP_POLICY='delete', KAFKA_TOPIC='CUSTOMERS_NORMALIZED_FINAL', PARTITIONS=1, REPLICAS=1, 
RETENTION_MS=604800000, VALUE_FORMAT='JSON') AS SELECT
  CAST(CUSTOMERS_SOURCE.PAYLOAD->AFTER->ID AS INTEGER) ID,
  UCASE(CAST(CUSTOMERS_SOURCE.PAYLOAD->AFTER->FIRST_NAME AS STRING)) FIRST_NAME,
  UCASE(CAST(CUSTOMERS_SOURCE.PAYLOAD->AFTER->LAST_NAME AS STRING)) LAST_NAME,
  LCASE(CAST(CUSTOMERS_SOURCE.PAYLOAD->AFTER->EMAIL AS STRING)) EMAIL,
  CAST(CUSTOMERS_SOURCE.PAYLOAD->AFTER->CREATED_AT AS BIGINT) CREATED_AT
FROM CUSTOMERS_SOURCE CUSTOMERS_SOURCE
WHERE (((((CUSTOMERS_SOURCE.PAYLOAD->OP IN ('c', 'u', 'r')) AND (CUSTOMERS_SOURCE.PAYLOAD->AFTER->ID IS NOT NULL)) AND (CUSTOMERS_SOURCE.PAY
LOAD->AFTER->FIRST_NAME IS NOT NULL)) AND (CUSTOMERS_SOURCE.PAYLOAD->AFTER->LAST_NAME IS NOT NULL)) AND (CUSTOMERS_SOURCE.PAYLOAD->AFTER->EM
AIL IS NOT NULL))
EMIT CHANGES;

PRINT 'CUSTOMERS_NORMALIZED_FINAL' FROM BEGINNING LIMIT 1;
SELECT payload FROM CUSTOMERS_SOURCE EMIT CHANGES LIMIT 1;